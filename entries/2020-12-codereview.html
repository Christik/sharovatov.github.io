<!DOCTYPE html>
<html>
<head>
    <title>Code review — долго, плохо, дорого</title>
	<meta property="og:title" value="Виталий Шароватов о разработке и людях">
	<meta property="og:description" value="Социально-технические системы — это не только просто, но и сложно">
	<meta property="og:type" value="website">
	<meta property="og:image" value="/me.jpg">
	<meta property="og:url" value="https://sharovatov.github.io">
    <link  rel="stylesheet" href="/styles/style.css" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="alternate" type="application/atom+xml" title="Vitaly Sharovatov" href="/atom.xml">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimal-ui">
</head>
<body>
    <div class="wrapper">
        <h1>Code review — долго, плохо, дорого</h1>
<p>В этой статье я попытаюсь подытожить обсужденную в Podlodka Crew с Филом Дельгядо, Виктором Фабриченко, Олегом Сорокой, Виталием Дмитриевым, Родионом Кривошеиным и Александром Агейченко тему эффективности практики код ревью в производстве программного обеспечения.</p>
<p>Статья предназначена в основном для тимлидов, руководителей разработки и других отвечающих за процесс разработки и поставки ПО товарищей.</p>
<p>Актуальность статьи обусловлена повсеместным использованием практики ревью кода даже в случаях, по мнению авторов, не подходящих для этой практики.</p>
<p>Начну с того, для чего код ревью используется чаще всего.</p>
<p>С небольшими вариациями код ревью используется в более-менее похожем процессе разработки, состоящим из следующих шагов:</p>
<ul>
<li>получение задачи</li>
<li>написание кода</li>
<li>ревью кода</li>
<li>тестирование</li>
<li>деплой</li>
</ul>
<h2 id="цели-ревью-кода">Цели ревью кода</h2>
<p>Обычно при использовании обязательного code review хотят (по крайней мере рассказывают, что хотят) примерно это:</p>
<ul>
<li><p><strong>сделать код понятнее</strong>. Это и проверки code style и контроль понятности названий переменных и методов и просто замечания &quot;тут не понятно&quot;.</p>
</li>
<li><p><strong>Избежать ошибок</strong>. От ошибок в реализации бизнес-логики до медленных алгоритмов. Ну и, конечно, насколько хорошо сделаны тесты.</p>
</li>
<li><p><strong>Уменьшить bus-factor</strong>. Когда в коде разбирается кто-то один - это опасно, а при обязательном ревью всегда будет кто-то, кто код прочтет.</p>
</li>
<li><p><strong>Обменяться знаниями</strong>. При ревью программист может подсмотреть какой-то неизвестный метод или языковую конструкцию и научиться.</p>
</li>
</ul>
<h2 id="цена-ревью-кода">Цена ревью кода</h2>
<p>Любая процессная активность для того, чтобы достигать своей цели, требует траты времени.</p>
<p>В процессной активности «ревью кода» трата времени разделяются на 4 основных категории:</p>
<ul>
<li>Время на само ревью</li>
<li>Время на доработку</li>
<li>Время переключения контекста и обсуждение</li>
<li>Время простоя задачи</li>
</ul>
<h3 id="время-на-саму-практику">Время на саму практику</h3>
<p>Процесс ревью кода занимает значительный процент времени работы над задачей. И чем тщательнее ревьюверы проверяют код на соответствие требуемым критериям, тем больший процент времени этот этап проверки занимает.</p>
<p><strong>Важно</strong>: общая трата времени кратна числу ревьюверов.</p>
<h3 id="время-на-доработку">Время на доработку</h3>
<p>В зависимости от того, насколько много изменений требуется сделать в задаче после ревью, время на доработку может достигать очень больших значений — порой до <em>70-80% от потраченного изначально</em>.</p>
<p>В ситуации, когда после внесения изменений на следующей фазе ревью требуются ещё правки, общее время выполнения задачи порой может увеличиваться вдвое.</p>
<h3 id="время-переключения-контекста-и-обсуждения">Время переключения контекста и обсуждения</h3>
<p>Сотрудник, которому нужно взять задачу на ревью, вынужден переключиться со своей задачи в код ревью, потом с код ревью снова на задачу. Само переключение контекста требует значительного времени (до получаса, по словам разных людей).</p>
<p><strong>Время переключения контекста изымается из работы сотрудника над его текущей задачей.</strong></p>
<p>В случае, если ревью не прошло, ревьювер готовит список комментариев к исправлению, отправляет задачу обратно на доработку, где у исполнителя произойдет еще одно переключение контекста.</p>
<p>В случае, если регламент компании после исправлений замечаний подразумевает еще один этап ревью кода, происходит еще два переключения контекста у ревьювера.</p>
<p>Если взять время переключения контекста за 15 минут, то:</p>
<ul>
<li>в идеальном случае, когда ревью кода проходит без замечаний, тратится 30 минут на переключение контекста (ревьювер переключается между своей задачей и ревью, а потом обратно)</li>
<li>в случае, когда ревью кода проходит с замечаниями, но исправленная версия не будет отревьювлена снова, потратится 60 минут (ревьювер переключается между своей задачей и ревью, а потом обратно; исполнитель переключается между своей задачей и результатами ревью, а потом обратно)</li>
<li>в случае нескольких ревьюверов или необходимости перепроверки после внесения изменений время переключения контекста увеличивается значительно.</li>
</ul>
<p>Когда регламент проведения ревью кода позволяет или поощряет обсуждения в ревью, время переключения контекста растет ужасающими темпами, также добавляется еще и время обсуждения. </p>
<p>Наверняка вы неоднократно видели ревью, в котором были просто-таки страницы комментариев и обсуждений, а то и срачей. Представьте, сколько раз переключался контекст у сотрудников, участвовавших в этом процессе, и какой был lead time у задачи.</p>
<h3 id="время-простоя-задачи">Время простоя задачи</h3>
<p>В процессе разработки задача, переведённая на ревью, может ожидать ревью значительное время, увеличивая тем самым lead time на количество часов простоя. Некоторые компании вносят в регламент процессов разработки требование ожидания ревью не более Х часов, что приводит к увеличению частоты переключения контекстов сотрудников, тем самым “размазывая” увеличение lead time конкретной задачи между несколькими сотрудниками.</p>
<h3 id="время-на-слияние-веток-после-ревью">Время на слияние веток после ревью</h3>
<p>В связи с тем, что задача, находящаяся в процессе код ревью, часто простаивает довольно долго, слияние ветки задачи с мастером может занять значительное время.</p>
<p>Есть статья товарищей из SkyEng <a href="https://habr.com/ru/company/oleg-bunin/blog/430666/">https://habr.com/ru/company/oleg-bunin/blog/430666/</a> , где они рассказывают, что 37% времени тратят на встречи и ревью, а еще 20% на баги и рефакторинг.</p>
<h3 id="дополнительные-факторы-увеличивающие-цену-практики">Дополнительные факторы, увеличивающие цену практики</h3>
<p>Есть несколько факторов, которые провоцируются или привносятся практикой ревью кода. Эти факторы увеличивают общую цену практики.</p>
<h4 id="выброшенный-труд">Выброшенный труд</h4>
<p>К моменту передачи задачи на ревью исполнитель ощущает, что он проделал значительную работу — проанализировал постановку задачи, написал код. Есть подспудное ощущение “сделанности”.</p>
<p>Когда по результату ревью оказывается, что нужно произвести множество изменений в задаче, а то и, порой, переписать её почти с нуля, у исполнителя возникает ощущение, что его работа “выкинута” и, порой, что она была бессмысленна.</p>
<p>Наверняка вам приходилось убеждать сотрудника, что этот процесс “нормален”, что “через это все проходят”.</p>
<p>Мотивированный на труд человек ассоциирует себя с собственноручно выполненной работой. Попробуйте попросить человека, даже никогда не вырезавшего по дереву, вырезать вам фигурку, а потом, получив ее (конечно же, кривенькую) — растопчите. Представьте себе ощущения человека в этот момент.</p>
<p>Бороться с ощущением “выкинутого” или “бессмысленного” труда довольно трудно, демотивирующий фактор здесь довольно серьёзен.</p>
<h4 id="ad-hominem">Ad hominem</h4>
<p>Довольно часто у сотрудников возникает ощущение, что у ревьювера “одни нападки”, а не конструктивная критика. В большинстве публично доступных регламентов ревью я вижу порой целые главы документа, описывающие, грубо говоря, “как не обидеть на ревью”.</p>
<p>Также часты ситуации, когда ревьювер действительно устраивает “истязание” кода, желая показаться более “умным”.</p>
<h4 id="разница-в-стилевых-предпочтениях-«войны-за-стиль»">Разница в стилевых предпочтениях, «войны за стиль»</h4>
<p>Разработчики часто предпочитают разные стили оформления кода, это нормально, потому как каждый привык к комфортному ему стилю.</p>
<p>Однако команде приходится работать с одним кодом, и разные предпочтения в оформлении приводят к конфликтам.</p>
<p>Чаще всего тимлиды пытаются административным решением принудить всех членов команды к использованию одного стиля, но порой споры все же появляются, и проявляются чаще всего в фазе ревью кода, порождая таким образом</p>
<h4 id="привычка-делать-тяп-ляп">Привычка делать тяп-ляп</h4>
<p>Если ревьюверы действительно хорошо проводят ревью кода и требуют множество мест, которые стоит исправить, у сотрудника может уменьшиться ответственность за качество: “сделаю тяп-ляп, проверять сам не буду, на ревью все равно найдут”.</p>
<p>Также сам процесс обучения становится неэффективным — человек сначала написал неправильно (отложилось в памяти), потом что-то частично поправил (не факт, что отложится так же).</p>
<p>Заодно уменьшается ответственность сотрудника и за простои в разработке — “а оно на ревью висело вон сколько, они задолбали фигню находить”.</p>
<p>Все эти факторы являются постоянной болью руководителей и команды, в зависимости от квалификации и осознанности руководителей и команды степень влияния этих проблем различается, так что конкретно сколько ресурсов тратится на уменьшения влияния этих факторов — неясно.</p>
<h3 id="вывод">Вывод</h3>
<p>Код-ревью — практика, не имеющая экономического обоснования к применению ни для одной из целей, для которых постулируется ее эффективность. Также практика код-ревью побуждает в командах паразитные негативные социальные динамики, постоянная борьба с которыми отнимает время и силы, а порой и является полностью неэффективной.</p>
<h2 id="замена-код-ревью">Замена код-ревью</h2>
<p>Рассмотрим замену практики код-ревью другими инструментами, позволяющими достичь всех целей, что ставятся перед код-ревью.</p>
<h3 id="сделать-код-понятнее">Сделать код понятнее</h3>
<p>Проверки code style должны перекладываться на линтеры.</p>
<p>Люди традиционно имеют различные преференции по оформлению кода.</p>
<p>В идеале создаются условия, в которых написанный код попадает в репозиторий в едином виде, а отображается в среде разработки программиста в удобном ему виде.</p>
<p>Тем самым мы избегаем вечных «войн пробелов с табами», программными средствами нивелируя пробле полностью.</p>
<p>Для javascript, например, дело решается eslint + prettier + husky.</p>
<h3 id="избежать-ошибок">Избежать ошибок</h3>
<p>От ошибок в реализации бизнес-логики до медленных алгоритмов. Ну и, конечно, насколько хорошо сделаны тесты.</p>
<h3 id="уменьшить-bus-factor">Уменьшить bus-factor</h3>
<p>Когда в коде разбирается кто-то один - это опасно, а при обязательном ревью всегда будет кто-то, кто код прочтет.</p>
<h3 id="обменяться-знаниями">Обменяться знаниями</h3>
<p>При ревью программист может подсмотреть какой-то неизвестный метод или языковую конструкцию и научиться.</p>

<div class="comments"><div id="disqus_thread"></div>
<script>
	(function(){
		window.disqus_shortname = 'sharovatov';
		window.disqus_developer = '1';
		window.disqus_url = 'http://sharovatov.github.io/entries/2020-12-codereview.html';
		window.disqus_identifier = 'entries-2020-12-codereview';
		window.disqus_title = 'Code review — долго, плохо, дорого';
		if ( window.DISQUS ) {
			return DISQUS.reset({
				reload: true,
				config: function () {
					this.page.identifier = window.disqus_identifier;
					this.page.url = window.disqus_url;
					this.page.title = window.disqus_title;
				}
			});
		}
		else {
		  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
		  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		}
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
    </div>
    
</body>
</html>